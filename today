#!/bin/sh
# today - keep a daily journal
# SPDX-FileCopyrightText: 2022 Sotiris Papatheodorou
# SPDX-License-Identifier: GPL-3.0-or-later
set -eu

usage() {
	name="${0##*/}"
	printf 'Usage: %s [[[YYYY-]MM-]DD] ...\n' "$name"
	printf '       %s grep ARGUMENT ...\n' "$name"
	printf '       %s -h\n' "$name"
}

date_file() {
	printf '%s/%s%s\n' "$TODAY_DIR" "$1" "$TODAY_SUFFIX"
}

todo_file() {
	printf '%s/todo%s\n' "$TODAY_DIR" "$TODAY_SUFFIX"
}

expand_date() {
	case "$1" in
		??)
			printf '%s\n' "$(date '+%Y-%m-')$1"
			;;
		??-??)
			printf '%s\n' "$(date '+%Y-')$1"
			;;
		*)
			printf '%s\n' "$1"
	esac
}

valid_date_file() {
	awk '
	function year(s) { sub("-..-..$", "", s); return s + 0 }
	function month(s) { sub("^....-", "", s); sub("-..$", "", s); return s + 0 }
	function day(s) { sub("^....-..-", "", s); return s + 0 }
	function is_leap(y) {
		if (y % 4 != 0) return 0
		else if (y % 100 != 0) return 1
		else if (y % 400 != 0) return 0
		else return 1
	}
	function valid_prefix(s) {
		prefix = "'"$TODAY_DIR/"'"
		l = length(prefix)
		return substr(s, 1, l) == prefix
	}
	function valid_suffix(s) {
		suffix = "'"$TODAY_SUFFIX"'"
		l = length(suffix)
		return substr(s, length(s) - l + 1) == suffix
	}
	BEGIN {
		days[1] = 31; days[2] = 28; days[3] = 31; days[4] = 30;
		days[5] = 31; days[6] = 30; days[7] = 31; days[8] = 31;
		days[9] = 30; days[10] = 31; days[11] = 30; days[12] = 31;
	}
	NF != 1 { next }
	{
		f = $0
		if (!valid_prefix(f)) next
		sub("^.*/", "", f)
		if (!valid_suffix(f)) next
		f = substr(f, 1, 10)
		if (f !~ /^[0-9]{4}-(0[1-9]|1[0-2])-([0-3][0-9])$/) next
		d = day(f)
		if (is_leap(year(f))) days[2] = 29; else days[2] = 28
		if (d < 1 || d > days[month(f)]) next
		print
	}'
}

dates_to_files() {
	filenames=''
	while [ "$#" -gt 0 ]
	do
		[ -n "$1" ] || continue
		filename=$(date_file "$(expand_date "$1")")
		filename=$(printf '%s\n' "$filename" | valid_date_file)
		if [ -n "$filename" ]
		then
			filenames=$(printf '%s\n%s' "$filenames" "$filename")
		else
			printf 'Invalid date: %s\n' "$1" >&2
			return 2
		fi
		shift
	done
	printf '%s' "$filenames" | sort
}

edit_file() {
	mkdir -p "${1%/*}"
	TODAY_FILE="$1"
	# shellcheck disable=SC2034
	TODAY_TODO=$(todo_file)
	set +e
	eval "$TODAY_CMD"
	set -e
	# Remove empty files.
	if [ ! -s "$TODAY_FILE" ]
	then
		rm -f "$TODAY_FILE"
	fi
	unset -v TODAY_FILE TODAY_TODO
}

search_files() {
	grep "$@" "$TODAY_DIR"/*"$TODAY_SUFFIX"
}

view_files() {
	cat "$@" | ${PAGER:-more}
}



# shellcheck disable=SC2016
TODAY_CMD=${TODAY_CMD:-'vim -c "above sp $TODAY_TODO" -c "tabe $TODAY_DIR" -c "tabr" "$TODAY_FILE"'}
TODAY_DIR=${TODAY_DIR-${XDG_DATA_HOME:-${HOME}/.local/share}/today}
TODAY_SUFFIX=${TODAY_SUFFIX-.gmi}

if [ "$#" -eq 0 ]
then
	set -- "$(date '+%Y-%m-%d')"
fi

case "$1" in
	grep)
		shift
		search_files "$@"
		;;
	-h)
		usage
		;;
	*)
		# shellcheck disable=SC2046
		set -- $(dates_to_files "$@")
		case "$#" in
			0)
				# Invalid date argument.
				usage >&2
				exit 2
				;;
			1)
				edit_file "$1"
				;;
			*)
				view_files "$@"
				;;
		esac
		;;
esac
